#+TITLE: Hooks                                                         
#+AUTHOR: VLEAD                                                                   
#+DATE: <2016-12-06 Tue>
                                            
#+Setupfile: ./org-templates/level-0.org                                          
#+TAGS: boilerplate(b)                                                            
#+EXCLUDE_TAGS: boilerplate                                                       
#+OPTIONS: ^:nil

* Introduction
  This Document represents how to  add resource id's into content of html
  files. 
* How to run
This file accepts 2 inputs:
1) Path to src folder that contains folders of labs with html files in them
2) Path to labspec.json file for corresponding lab
<<<<<<< HEAD
* How to run
=======
>>>>>>> 679fb102c3c00f22ff9fc68cf6393cc21781e17b
#+BEGIN_EXAMPLE
python add-ids.py $[HOME]/src $[HOME]/labSpec.json
#+END_EXAMPLE
* Implementation
** imports
  :PROPERTIES:
  :CUSTOM_ID: imports
  :END:   

#+BEGIN_SRC python :tangle add-ids.py
from bs4 import BeautifulSoup
from os import listdir
from os.path import isfile, join, splitext
import sys, json, re
from config.config import URL

#+END_SRC

** Handling Convention
   All non-alphanumeric characters are dropped and spaces are replaced with hyphen
  :PROPERTIES:
  :CUSTOM_ID: editName
  :END:   

#+BEGIN_SRC python :tangle add-ids.py
def editName(name):
	name = name.lower()
	newName = re.sub(r'[^a-zA-Z0-9\s+-]', '', name)
	newName = newName.strip()
	finalName = re.sub('\s+', '-', newName)
	return finalName

#+END_SRC

** Insert Ids
   Using BeautifulSoup, a parse tree is obtained making it easy to search and
   insert into the tree
  :PROPERTIES:
  :CUSTOM_ID: addHooks
  :END:   

<<<<<<< HEAD
#+BEGIN_SRC python :tangle addIds.py
def addHooks(jsonIds, labDirPath):#files, expPath, labName, expName):
	expList = listdir(join(labDirPath, 'src'))
        for d in expList:
                jsonExpList = jsonIds.get('experiments').get('name')
                
                if d == expName:
                       ids = jsonIds.get('experiments').get('')
        for f in files:
=======
#+BEGIN_SRC python :tangle add-ids.py
def addHooks(files, expPath, labName, expName):
	for f in files:
>>>>>>> 679fb102c3c00f22ff9fc68cf6393cc21781e17b
		fileName, ext = splitext(f)
		if ext == '.html':
			ptree = BeautifulSoup(open(join(labDirPath, join('src',f))))
                        
			headList = ptree.find_all(re.compile("^h[0-9]$"))
			for h in headList:
				h['id'] = labName + '-' + expName + '-' + fileName
			pList = ptree.find_all('p')
			for p in pList:
				p['id'] = labName + '-' + expName + '-' + fileName +'-content'	
			new_html_content = ptree.prettify()
			k = open(join(expPath,f), 'w+')
			k.write(new_html_content)
			k.close()

#+END_SRC
** Config
#+BEGIN_SRC python :tangle config/config.py
URL = 'http://127.0.0.1:5000/'

#+END_SRC

** Send Request
#+BEGIN_SRC python :tangle addIds.py
def sendRequest(url):
        try:
            json = requests.get(url)
        except Exception as error:
            print ('Error: '+str(error))
        return json
        

#+END_SRC
* Execution
#+BEGIN_SRC python :tangle add-ids.py
if __name__ == '__main__':
	try:
		labDirPath = sys.argv[1]
                jsonPath = sys.argv[2]
	except Exception as error:
		print('Error: '+str(error))
        with open(jsonPath) as data_file:
		data = json.load(data_file)
	#exps = data.get('experiments')
     	labId = data.get('course').get('id')
#        labFolderName = editName(data.get('course').get('display_name'))
        #labName = editName(labName)
        newURL = URL + labId
        print newURL
        jsonIds = sendRequest(newURL)
        addHooks(jsonIds, labDirPath)
#	for i in exps:
#		expName = i.get('name')
#		expName = editName(expName)
#		expPath = join(dirPath, expName)
#		onlyfiles = [f for f in listdir(expPath) if isfile(join(expPath, f))]
#		addHooks(onlyfiles, expPath, labName, expName)

#+END_SRC
